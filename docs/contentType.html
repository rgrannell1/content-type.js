<!DOCTYPE html>

<html>
<head>
  <title>contentType.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="contentType.html">
                  contentType.js
                </a>
              
                
                <a class="source" href="mimetype.html">
                  mimetype.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>contentType.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>#!<span class="hljs-regexp">/usr/</span>bin/env node
<span class="hljs-pi">"use strict"</span>;

<span class="hljs-keyword">var</span> zipKeys = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">zipKeys</span><span class="hljs-params">(colls)</span> </span>{

	<span class="hljs-keyword">var</span> out = {};
	colls.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pair)</span> </span>{
		<span class="hljs-keyword">return</span> out[pair[<span class="hljs-number">0</span>]] = pair[<span class="hljs-number">1</span>];
	});
	<span class="hljs-keyword">return</span> out;
};

<span class="hljs-keyword">var</span> lastOf = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">lastOf</span><span class="hljs-params">(coll)</span> </span>{
	<span class="hljs-keyword">return</span> coll[coll.length - <span class="hljs-number">1</span>];
};

{
	<span class="hljs-keyword">var</span> grammar;

	(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{

		<span class="hljs-keyword">var</span> toState = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(state)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(char)</span> </span>{
				<span class="hljs-keyword">return</span> [char, state];
			};
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>— the control ascii characters (inc. delete)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> control = [<span class="hljs-string">"\u0000"</span>, <span class="hljs-string">"\u0001"</span>, <span class="hljs-string">"\u0002"</span>, <span class="hljs-string">"\u0003"</span>, <span class="hljs-string">"\u0004"</span>, <span class="hljs-string">"\u0005"</span>, <span class="hljs-string">"\u0006"</span>, <span class="hljs-string">"\u0007"</span>, <span class="hljs-string">"\b"</span>, <span class="hljs-string">"\t"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">"\u000b"</span>, <span class="hljs-string">"\f"</span>, <span class="hljs-string">"\r"</span>, <span class="hljs-string">"\u000e"</span>, <span class="hljs-string">"\u000f"</span>, <span class="hljs-string">"\u0010"</span>, <span class="hljs-string">"\u0011"</span>, <span class="hljs-string">"\u0012"</span>, <span class="hljs-string">"\u0013"</span>, <span class="hljs-string">"\u0014"</span>, <span class="hljs-string">"\u0015"</span>, <span class="hljs-string">"\u0016"</span>, <span class="hljs-string">"\u0017"</span>, <span class="hljs-string">"\u0018"</span>, <span class="hljs-string">"\u0019"</span>, <span class="hljs-string">"\u001a"</span>, <span class="hljs-string">"\u001b"</span>, <span class="hljs-string">"\u001c"</span>, <span class="hljs-string">"\u001d"</span>, <span class="hljs-string">"\u001e"</span>, <span class="hljs-string">"\u001f"</span>, <span class="hljs-string">""</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>— tspecials must be in quoted string to use in parametre value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> tspecials = [<span class="hljs-string">"("</span>, <span class="hljs-string">")"</span>, <span class="hljs-string">"&lt;"</span>, <span class="hljs-string">"&gt;"</span>, <span class="hljs-string">"@"</span>, <span class="hljs-string">","</span>, <span class="hljs-string">";"</span>, <span class="hljs-string">":"</span>, <span class="hljs-string">"\\"</span>, <span class="hljs-string">"\""</span>, <span class="hljs-string">"/"</span>, <span class="hljs-string">"["</span>, <span class="hljs-string">"]"</span>, <span class="hljs-string">"?"</span>, <span class="hljs-string">"="</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>— all ascii characters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> ascii = [<span class="hljs-string">"\u0000"</span>, <span class="hljs-string">"\u0001"</span>, <span class="hljs-string">"\u0002"</span>, <span class="hljs-string">"\u0003"</span>, <span class="hljs-string">"\u0004"</span>, <span class="hljs-string">"\u0005"</span>, <span class="hljs-string">"\u0006"</span>, <span class="hljs-string">"\u0007"</span>, <span class="hljs-string">"\b"</span>, <span class="hljs-string">"\t"</span>, <span class="hljs-string">"\n"</span>, <span class="hljs-string">"\u000b"</span>, <span class="hljs-string">"\f"</span>, <span class="hljs-string">"\r"</span>, <span class="hljs-string">"\u000e"</span>, <span class="hljs-string">"\u000f"</span>, <span class="hljs-string">"\u0010"</span>, <span class="hljs-string">"\u0011"</span>, <span class="hljs-string">"\u0012"</span>, <span class="hljs-string">"\u0013"</span>, <span class="hljs-string">"\u0014"</span>, <span class="hljs-string">"\u0015"</span>, <span class="hljs-string">"\u0016"</span>, <span class="hljs-string">"\u0017"</span>, <span class="hljs-string">"\u0018"</span>, <span class="hljs-string">"\u0019"</span>, <span class="hljs-string">"\u001a"</span>, <span class="hljs-string">"\u001b"</span>, <span class="hljs-string">"\u001c"</span>, <span class="hljs-string">"\u001d"</span>, <span class="hljs-string">"\u001e"</span>, <span class="hljs-string">"\u001f"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">"!"</span>, <span class="hljs-string">"\""</span>, <span class="hljs-string">"#"</span>, <span class="hljs-string">"$"</span>, <span class="hljs-string">"%"</span>, <span class="hljs-string">"&amp;"</span>, <span class="hljs-string">"'"</span>, <span class="hljs-string">"("</span>, <span class="hljs-string">")"</span>, <span class="hljs-string">"*"</span>, <span class="hljs-string">"+"</span>, <span class="hljs-string">","</span>, <span class="hljs-string">"-"</span>, <span class="hljs-string">"."</span>, <span class="hljs-string">"/"</span>, <span class="hljs-string">"0"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>, <span class="hljs-string">"4"</span>, <span class="hljs-string">"5"</span>, <span class="hljs-string">"6"</span>, <span class="hljs-string">"7"</span>, <span class="hljs-string">"8"</span>, <span class="hljs-string">"9"</span>, <span class="hljs-string">":"</span>, <span class="hljs-string">";"</span>, <span class="hljs-string">"&lt;"</span>, <span class="hljs-string">"="</span>, <span class="hljs-string">"&gt;"</span>, <span class="hljs-string">"?"</span>, <span class="hljs-string">"@"</span>, <span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>, <span class="hljs-string">"D"</span>, <span class="hljs-string">"E"</span>, <span class="hljs-string">"F"</span>, <span class="hljs-string">"G"</span>, <span class="hljs-string">"H"</span>, <span class="hljs-string">"I"</span>, <span class="hljs-string">"J"</span>, <span class="hljs-string">"K"</span>, <span class="hljs-string">"L"</span>, <span class="hljs-string">"M"</span>, <span class="hljs-string">"N"</span>, <span class="hljs-string">"O"</span>, <span class="hljs-string">"P"</span>, <span class="hljs-string">"Q"</span>, <span class="hljs-string">"R"</span>, <span class="hljs-string">"S"</span>, <span class="hljs-string">"T"</span>, <span class="hljs-string">"U"</span>, <span class="hljs-string">"V"</span>, <span class="hljs-string">"W"</span>, <span class="hljs-string">"X"</span>, <span class="hljs-string">"Y"</span>, <span class="hljs-string">"Z"</span>, <span class="hljs-string">"["</span>, <span class="hljs-string">"\\"</span>, <span class="hljs-string">"]"</span>, <span class="hljs-string">"^"</span>, <span class="hljs-string">"_"</span>, <span class="hljs-string">"`"</span>, <span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"e"</span>, <span class="hljs-string">"f"</span>, <span class="hljs-string">"g"</span>, <span class="hljs-string">"h"</span>, <span class="hljs-string">"i"</span>, <span class="hljs-string">"j"</span>, <span class="hljs-string">"k"</span>, <span class="hljs-string">"l"</span>, <span class="hljs-string">"m"</span>, <span class="hljs-string">"n"</span>, <span class="hljs-string">"o"</span>, <span class="hljs-string">"p"</span>, <span class="hljs-string">"q"</span>, <span class="hljs-string">"r"</span>, <span class="hljs-string">"s"</span>, <span class="hljs-string">"t"</span>, <span class="hljs-string">"u"</span>, <span class="hljs-string">"v"</span>, <span class="hljs-string">"w"</span>, <span class="hljs-string">"x"</span>, <span class="hljs-string">"y"</span>, <span class="hljs-string">"z"</span>, <span class="hljs-string">"{"</span>, <span class="hljs-string">"|"</span>, <span class="hljs-string">"}"</span>, <span class="hljs-string">"~"</span>, <span class="hljs-string">""</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>— all non-control ascii characters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> printable = ascii.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(char)</span> </span>{
			<span class="hljs-keyword">return</span> control.indexOf(char) === -<span class="hljs-number">1</span>;
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>— any ascii character except the tspecials, space, and the CTRL characters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> tokenChar = printable.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(char)</span> </span>{
			<span class="hljs-keyword">return</span> char !== <span class="hljs-string">" "</span> &amp;&amp; tspecials.indexOf(char) === -<span class="hljs-number">1</span>;
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>— real states</p>
<p>these states represent parts of the contentType,
such as the type, or attributes.</p>

            </div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>— type
non whitespace tokens. exit when the first slash is reached.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> type = zipKeys([[<span class="hljs-string">"/"</span>, <span class="hljs-string">"_SLASH"</span>]].concat(tokenChar.map(toState(<span class="hljs-string">"type"</span>))));</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>— subtype
non whitespace tokens. exit when the semicolon is reached.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> subtype = zipKeys([[<span class="hljs-string">";"</span>, <span class="hljs-string">"_SPACE"</span>]].concat(tokenChar.map(toState(<span class="hljs-string">"subtype"</span>))));</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>— attribute
non whitespace tokens. exit when the ‘=’ delimiter for that parametre is reached.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> attribute = zipKeys([[<span class="hljs-string">"="</span>, <span class="hljs-string">"_EQUAL"</span>]].concat(tokenChar.map(toState(<span class="hljs-string">"attribute"</span>))));</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>— single-quoted
any printable ascii character except ‘.  exit when ‘ is reached.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> singleQuoted = zipKeys([[<span class="hljs-string">"'"</span>, <span class="hljs-string">"_SPACE"</span>]].concat(printable.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(char)</span> </span>{
			<span class="hljs-keyword">return</span> char !== <span class="hljs-string">"'"</span>;
		}).map(toState(<span class="hljs-string">"single-quoted"</span>))));</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>— double-quoted
any printable ascii character except “. exit when “ is reached</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> doubleQuoted = zipKeys([[<span class="hljs-string">"\""</span>, <span class="hljs-string">"_SPACE"</span>]].concat(printable.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(char)</span> </span>{
			<span class="hljs-keyword">return</span> char !== <span class="hljs-string">"\""</span>;
		}).map(toState(<span class="hljs-string">"double-quoted"</span>))));</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>— unquoted</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> unquoted = zipKeys([[<span class="hljs-string">";"</span>, <span class="hljs-string">"_SPACE"</span>]].concat(tokenChar.map(toState(<span class="hljs-string">"unquoted"</span>))));</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>— virtual states</p>
<p>these states represent delimiters between tokens.</p>

            </div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>— _SLASH
transition immediately to the subtype definition.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> _SLASH = zipKeys(tokenChar.map(toState(<span class="hljs-string">"subtype"</span>)));</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>— _EQUAL
if the equal is succeeded by a quote, transition to a quoted attribute.
otherwise, transition to an unquoted parameter value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> _EQUAL = zipKeys([[<span class="hljs-string">"\""</span>, <span class="hljs-string">"double-quoted"</span>], [<span class="hljs-string">"'"</span>, <span class="hljs-string">"single-quoted"</span>]].concat(tokenChar.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(char)</span> </span>{
			<span class="hljs-keyword">return</span> [char, <span class="hljs-string">"unquoted"</span>];
		})));</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>— _SPACE
multiple semicolon are supported.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
		<span class="hljs-keyword">var</span> _SPACE = zipKeys([[<span class="hljs-string">";"</span>, <span class="hljs-string">"_SPACE"</span>], [<span class="hljs-string">" "</span>, <span class="hljs-string">"_SPACE"</span>], [<span class="hljs-string">"\t"</span>, <span class="hljs-string">"_SPACE"</span>], [<span class="hljs-string">"\n"</span>, <span class="hljs-string">"_SPACE"</span>]].concat(tokenChar.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(char)</span> </span>{
			<span class="hljs-keyword">return</span> [<span class="hljs-string">";"</span>, <span class="hljs-string">" "</span>, <span class="hljs-string">"\t"</span>, <span class="hljs-string">"\n"</span>].indexOf(char) === -<span class="hljs-number">1</span>;
		}).map(toState(<span class="hljs-string">"attribute"</span>))));

		grammar = {

			type: type,
			subtype: subtype,
			attribute: attribute,
			<span class="hljs-string">"single-quoted"</span>: singleQuoted,
			<span class="hljs-string">"double-quoted"</span>: doubleQuoted,
			unquoted: unquoted,

			_SLASH: _SLASH,
			_EQUAL: _EQUAL,
			_SPACE: _SPACE

		};
	})();
}

<span class="hljs-keyword">var</span> lex = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(contentType)</span> </span>{

	<span class="hljs-keyword">var</span> state = <span class="hljs-string">"type"</span>;
	<span class="hljs-keyword">var</span> transitions = [];
	<span class="hljs-keyword">var</span> chars = contentType.split(<span class="hljs-string">""</span>);

	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> ith = <span class="hljs-number">0</span>; ith &lt; chars.length; ++ith) {

		<span class="hljs-keyword">var</span> char = chars[ith];

		<span class="hljs-keyword">if</span> (transitions.length &gt; <span class="hljs-number">0</span>) {
			state = transitions[transitions.length - <span class="hljs-number">1</span>][<span class="hljs-number">1</span>];
		}

		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> grammar[state][char] !== <span class="hljs-string">"undefined"</span>) {
			transitions.push([char, grammar[state][char]]);
		} <span class="hljs-keyword">else</span> {

			<span class="hljs-keyword">var</span> current = transitions.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pair)</span> </span>{
				<span class="hljs-keyword">return</span> pair[<span class="hljs-number">0</span>];
			}).join(<span class="hljs-string">""</span>);
			<span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unexpected \""</span> + char + <span class="hljs-string">"\" in content-type header: "</span> + current + <span class="hljs-string">", "</span> + state);
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>— drop the temporary transitions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">return</span> transitions.filter(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(trans)</span> </span>{
		<span class="hljs-keyword">return</span> trans[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] !== <span class="hljs-string">"_"</span>;
	});
};

<span class="hljs-keyword">var</span> label = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(lexeme)</span> </span>{

	<span class="hljs-keyword">var</span> tokens = [];

	lexeme.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(state, ith)</span> </span>{

		<span class="hljs-keyword">if</span> (tokens.length &gt; <span class="hljs-number">0</span> &amp;&amp; lastOf(lastOf(tokens))[<span class="hljs-number">1</span>] === state[<span class="hljs-number">1</span>]) {
			lastOf(tokens).push(state);
		} <span class="hljs-keyword">else</span> {
			tokens.push([state]);
		}
	});

	<span class="hljs-keyword">return</span> tokens.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(token)</span> </span>{

		<span class="hljs-keyword">var</span> label = token[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];
		<span class="hljs-keyword">var</span> text = token.map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(state)</span> </span>{
			<span class="hljs-keyword">return</span> state[<span class="hljs-number">0</span>];
		}).join(<span class="hljs-string">""</span>);

		<span class="hljs-keyword">if</span> (label === <span class="hljs-string">"double-quoted"</span>) {
			text += <span class="hljs-string">"\""</span>;
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (label === <span class="hljs-string">"single-quoted"</span>) {
			text += <span class="hljs-string">"'"</span>;
		}

		<span class="hljs-keyword">return</span> [label, text];
	});
};

<span class="hljs-keyword">var</span> parseLexeme = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(contentType, lexeme)</span> </span>{

	<span class="hljs-keyword">var</span> labels = label(lexeme);

	<span class="hljs-keyword">if</span> (labels.length &lt; <span class="hljs-number">2</span>) {
		<span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"invalid contentType; must contain type and subtype ("</span> + contentType + <span class="hljs-string">")"</span>);
	}

	<span class="hljs-keyword">var</span> types = [<span class="hljs-string">"application"</span>, <span class="hljs-string">"audio"</span>, <span class="hljs-string">"example"</span>, <span class="hljs-string">"image"</span>, <span class="hljs-string">"message"</span>, <span class="hljs-string">"model"</span>, <span class="hljs-string">"multipart"</span>, <span class="hljs-string">"text"</span>, <span class="hljs-string">"video"</span>];

	<span class="hljs-keyword">try</span> {

		<span class="hljs-keyword">if</span> (types.indexOf(labels[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].toLowerCase()) === -<span class="hljs-number">1</span>) {
			<span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"invalid content type "</span> + labels[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>].toLowerCase());
		}

		<span class="hljs-keyword">var</span> params = {};

		<span class="hljs-keyword">var</span> options = labels.slice(<span class="hljs-number">2</span>);

		<span class="hljs-keyword">if</span> (options.length % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"parsing failed: odd number of tokens."</span>);
		}

		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> ith = <span class="hljs-number">0</span>; ith &lt; options.length; ith += <span class="hljs-number">2</span>) {
			params[options[ith][<span class="hljs-number">0</span>]] = options[ith + <span class="hljs-number">1</span>][<span class="hljs-number">0</span>];
		}

		<span class="hljs-keyword">return</span> {
			type: labels[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>],
			subtype: labels[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>],
			params: params
		};
	} <span class="hljs-keyword">catch</span> (err) {

		<span class="hljs-keyword">var</span> labelString = <span class="hljs-built_in">JSON</span>.stringify(labels);
		<span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"failed to parse content-type tokens: "</span> + err.message + <span class="hljs-string">", "</span> + labelString);
	}
};

<span class="hljs-keyword">var</span> parse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(grammar, contentType)</span> </span>{

	parse.precond(contentType);

	<span class="hljs-keyword">return</span> parseLexeme(contentType, label(lex(contentType)));
};

parse.precond = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(contentType)</span> </span>{

	<span class="hljs-keyword">var</span> argClass = <span class="hljs-built_in">Object</span>.prototype.toString.call(contentType);

	<span class="hljs-keyword">if</span> (argClass !== <span class="hljs-string">"[object String]"</span>) {
		<span class="hljs-keyword">throw</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"contentType must be a string: actual "</span> + argClass);
	}
};

<span class="hljs-keyword">var</span> deparse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(_ref)</span> </span>{
	<span class="hljs-keyword">var</span> type = _ref.type;
	<span class="hljs-keyword">var</span> subtype = _ref.subtype;
	<span class="hljs-keyword">var</span> params = _ref.params;

	deparse.precond(type, subtype, params);

	<span class="hljs-keyword">var</span> paramString = <span class="hljs-built_in">Object</span>.keys(params).map(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name)</span> </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-string">"; "</span> + name + <span class="hljs-string">"="</span> + params[name];
	}).join(<span class="hljs-string">""</span>);

	<span class="hljs-keyword">return</span> <span class="hljs-string">""</span> + type + <span class="hljs-string">"/"</span> + subtype + <span class="hljs-string">""</span> + paramString;
};

deparse.precond = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, subtype, params)</span> </span>{

	<span class="hljs-keyword">var</span> typeClass = <span class="hljs-built_in">Object</span>.prototype.toString.call(type);
	<span class="hljs-keyword">var</span> subtypeClass = <span class="hljs-built_in">Object</span>.prototype.toString.call(subtype);
	<span class="hljs-keyword">var</span> paramsClass = <span class="hljs-built_in">Object</span>.prototype.toString.call(params);

	<span class="hljs-keyword">var</span> input = <span class="hljs-built_in">JSON</span>.stringify({ type: type, subtype: subtype, params: params });

	<span class="hljs-keyword">if</span> (typeClass !== <span class="hljs-string">"[object String]"</span>) {
		<span class="hljs-keyword">throw</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"type must be a string: actual "</span> + typeClass + <span class="hljs-string">", input "</span> + input);
	}

	<span class="hljs-keyword">if</span> (subtypeClass !== <span class="hljs-string">"[object String]"</span>) {
		<span class="hljs-keyword">throw</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"subtype must be a string: actual "</span> + subtypeClass + <span class="hljs-string">", input "</span> + input);
	}

	<span class="hljs-keyword">if</span> (paramsClass !== <span class="hljs-string">"[object Object]"</span>) {
		<span class="hljs-keyword">throw</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"params must be a string: actual "</span> + paramsClass + <span class="hljs-string">", input "</span> + input);
	}

	<span class="hljs-built_in">Object</span>.keys(params).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(param, ith)</span> </span>{

		<span class="hljs-keyword">var</span> paramClass = <span class="hljs-built_in">Object</span>.prototype.toString.call(params[param]);

		<span class="hljs-keyword">if</span> (paramClass !== <span class="hljs-string">"[object String]"</span>) {
			<span class="hljs-keyword">throw</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"parameter number "</span> + ith + <span class="hljs-string">" must be a string: actual "</span> + paramClass);
		}
	});
};

<span class="hljs-keyword">var</span> parse = parse.bind({}, strictGrammar);
<span class="hljs-keyword">var</span> laxParse = parse.bind({}, looseGrammar);

<span class="hljs-built_in">module</span>.exports = {
	parse: parse,
	laxParse: laxParse,
	deparse: deparse
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
